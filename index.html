<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة مقارنة الأنظمة الشمسية - Solar Systems Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .period-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .navigation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f0f0f0;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-nav {
            background: #4CAF50;
            color: white;
            padding: 12px 25px;
        }

        .btn-nav:hover {
            background: #45a049;
        }

        .current-date {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            min-width: 250px;
            text-align: center;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
            height: 550px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .device-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .device-card h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .device-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .device-stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 0.95em;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .stat-value.success {
            color: #4CAF50;
        }

        .stat-value.warning {
            color: #FF9800;
        }

        .stat-value.danger {
            color: #f44336;
        }

        .fault-badge {
            background: #f44336;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .period-controls, .navigation-controls {
                flex-direction: column;
            }
            
            .chart-container {
                height: 450px;
            }

            .current-date {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ لوحة مقارنة الأنظمة الشمسية</h1>
            <p>Solar Systems Comparison Dashboard</p>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>
        <div id="loading" class="loading">جاري تحميل البيانات... Loading data...</div>

        <div id="content" style="display: none;">
            <div class="controls">
                <div class="period-controls">
                    <button class="btn active" data-period="daily">يومي - Daily</button>
                    <button class="btn" data-period="weekly">أسبوعي - Weekly</button>
                    <button class="btn" data-period="monthly">شهري - Monthly</button>
                    <button class="btn" data-period="yearly">سنوي - Yearly</button>
                </div>
                
                <div class="navigation-controls">
                    <button class="btn btn-nav" id="prevBtn">⟨ السابق - Previous</button>
                    <div class="current-date" id="currentDate"></div>
                    <button class="btn btn-nav" id="nextBtn">التالي - Next ⟩</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="powerChart"></canvas>
            </div>

            <div class="comparison-grid" id="comparisonGrid"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "YAIzaSyBA1bGlVtLd5EOSUxe-JlL3zjnX5qbk010",
            authDomain: "Ysolar-81398.firebaseapp.com",
            databaseURL: "https://solar-81398-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "solar-81398",
            storageBucket: "solar-81398.appspot.com",
            messagingSenderId: "Y839500496800",
            appId: "1:839500496800:web:f7e16d4a9ab1dfd45faec5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allData = [];
        let chart = null;
        let currentPeriod = 'daily';
        let currentDate = new Date();

        // Device names (fixed order)
        const deviceNames = ["Essa صافي قياس", "Wael مبادرة", "Essa مبـادرة", "Osama"];

        // Load data from Firebase
        function loadData() {
            const solarRef = database.ref('solar');
            
            solarRef.once('value')
                .then(snapshot => {
                    allData = [];
                    snapshot.forEach(child => {
                        const data = child.val();
                        allData.push(data);
                    });

                    if (allData.length === 0) {
                        showError('لا توجد بيانات - No data available');
                        return;
                    }

                    updateDisplay();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                })
                .catch(error => {
                    showError('خطأ في تحميل البيانات - Error loading data: ' + error.message);
                });
        }

        // Get date range based on period
        function getDateRange() {
            let start, end;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const date = currentDate.getDate();

            if (currentPeriod === 'daily') {
                start = new Date(year, month, date, 0, 0, 0);
                end = new Date(year, month, date, 23, 59, 59);
            } else if (currentPeriod === 'weekly') {
                const day = currentDate.getDay();
                const diff = currentDate.getDate() - day;
                start = new Date(year, month, diff, 0, 0, 0);
                end = new Date(year, month, diff + 6, 23, 59, 59);
            } else if (currentPeriod === 'monthly') {
                start = new Date(year, month, 1, 0, 0, 0);
                end = new Date(year, month + 1, 0, 23, 59, 59);
            } else { // yearly
                start = new Date(year, 0, 1, 0, 0, 0);
                end = new Date(year, 11, 31, 23, 59, 59);
            }

            return { start, end };
        }

        // Filter data for current period
        function filterDataForPeriod() {
            const { start, end } = getDateRange();
            
            return allData.filter(item => {
                const itemDate = new Date(item.timestamp);
                return itemDate >= start && itemDate <= end;
            });
        }

        // Calculate device statistics
        function calculateDeviceStats(deviceName, filteredData) {
            const deviceData = filteredData.filter(d => d.site === deviceName);
            
            let totalProduction = 0;
            let faultCount = 0;
            let validReadings = 0;

            deviceData.forEach(item => {
                if (item.power === '--' || item.status === 'Fault') {
                    faultCount++;
                } else {
                    const power = parseFloat(item.power);
                    if (!isNaN(power)) {
                        totalProduction += power;
                        validReadings++;
                    }
                }
            });

            const avgProduction = validReadings > 0 ? totalProduction / validReadings : 0;

            return {
                totalProduction,
                avgProduction,
                faultCount,
                validReadings,
                totalReadings: deviceData.length
            };
        }

        // Update chart
        function updateChart() {
            const filteredData = filterDataForPeriod();
            
            const labels = [];
            const data = [];
            const colors = [];
            const faults = [];

            deviceNames.forEach(deviceName => {
                const stats = calculateDeviceStats(deviceName, filteredData);
                
                labels.push(deviceName);
                data.push(stats.totalProduction);
                faults.push(stats.faultCount);

                // Determine bar color
                if (stats.faultCount > 0 && stats.totalProduction === 0) {
                    colors.push('rgba(244, 67, 54, 0.7)'); // Red for faults
                } else if (stats.totalProduction === 0) {
                    colors.push('rgba(255, 152, 0, 0.7)'); // Orange for zero production
                } else {
                    colors.push('rgba(76, 175, 80, 0.7)'); // Green for normal
                }
            });

            const ctx = document.getElementById('powerChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'إجمالي الإنتاج (kW/h) - Total Production',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.7', '1')),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const deviceIndex = context.dataIndex;
                                    const production = context.parsed.y.toFixed(3);
                                    const fault = faults[deviceIndex];
                                    return [
                                        `الإنتاج: ${production} kW/h`,
                                        `الأعطال: ${fault}`
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                return value.toFixed(2);
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'إجمالي الإنتاج (kW/h) - Total Production',
                                font: { size: 14 }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'الأجهزة - Devices',
                                font: { size: 14 }
                            },
                            ticks: {
                                font: { size: 12 }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Update comparison cards
        function updateComparisonCards() {
            const filteredData = filterDataForPeriod();
            const grid = document.getElementById('comparisonGrid');
            grid.innerHTML = '';

            deviceNames.forEach(deviceName => {
                const stats = calculateDeviceStats(deviceName, filteredData);
                
                const card = document.createElement('div');
                card.className = 'device-card';
                
                let productionClass = 'success';
                if (stats.totalProduction === 0) productionClass = 'warning';
                if (stats.faultCount > 0) productionClass = 'danger';

                card.innerHTML = `
                    <h3>${deviceName}</h3>
                    
                    <div class="device-stat">
                        <span class="stat-label">إجمالي الإنتاج - Total Production</span>
                        <span class="stat-value ${productionClass}">${stats.totalProduction.toFixed(3)} kW/h</span>
                    </div>
                    
                    <div class="device-stat">
                        <span class="stat-label">متوسط الإنتاج - Average Production</span>
                        <span class="stat-value ${productionClass}">${stats.avgProduction.toFixed(3)} kW/h</span>
                    </div>
                    
                    <div class="device-stat">
                        <span class="stat-label">عدد القراءات - Total Readings</span>
                        <span class="stat-value">${stats.totalReadings}</span>
                    </div>
                    
                    <div class="device-stat">
                        <span class="stat-label">القراءات الصحيحة - Valid Readings</span>
                        <span class="stat-value">${stats.validReadings}</span>
                    </div>
                    
                    <div class="device-stat">
                        <span class="stat-label">عدد الأعطال - Faults Count</span>
                        <span class="stat-value ${stats.faultCount > 0 ? 'danger' : 'success'}">
                            ${stats.faultCount > 0 ? `<span class="fault-badge">${stats.faultCount}</span>` : '0'}
                        </span>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Update current date display
        function updateDateDisplay() {
            const dateStr = document.getElementById('currentDate');
            
            if (currentPeriod === 'daily') {
                dateStr.textContent = currentDate.toLocaleDateString('ar-EG', { 
                    year: 'numeric', month: 'long', day: 'numeric' 
                });
            } else if (currentPeriod === 'weekly') {
                const { start, end } = getDateRange();
                dateStr.textContent = `${start.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            } else if (currentPeriod === 'monthly') {
                dateStr.textContent = currentDate.toLocaleDateString('ar-EG', { 
                    year: 'numeric', month: 'long' 
                });
            } else {
                dateStr.textContent = currentDate.getFullYear().toString();
            }
        }

        // Navigate to previous period
        function navigatePrevious() {
            if (currentPeriod === 'daily') {
                currentDate.setDate(currentDate.getDate() - 1);
            } else if (currentPeriod === 'weekly') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else if (currentPeriod === 'monthly') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setFullYear(currentDate.getFullYear() - 1);
            }
            updateDisplay();
        }

        // Navigate to next period
        function navigateNext() {
            if (currentPeriod === 'daily') {
                currentDate.setDate(currentDate.getDate() + 1);
            } else if (currentPeriod === 'weekly') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else if (currentPeriod === 'monthly') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else {
                currentDate.setFullYear(currentDate.getFullYear() + 1);
            }
            updateDisplay();
        }

        // Update all displays
        function updateDisplay() {
            updateDateDisplay();
            updateChart();
            updateComparisonCards();
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        // Event listeners
        document.querySelectorAll('.btn[data-period]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn[data-period]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                currentDate = new Date(); // Reset to today
                updateDisplay();
            });
        });

        document.getElementById('prevBtn').addEventListener('click', navigatePrevious);
        document.getElementById('nextBtn').addEventListener('click', navigateNext);

        // Load data on page load
        loadData();

        // Refresh data every 5 minutes
        setInterval(loadData, 300000);
    </script>
</body>
</html>
